<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tournament Subscriptions (WebSocket)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="flex gap-6">
    <div class="w-1/4 bg-white p-4 rounded-2xl shadow">
      <h2 class="text-xl font-bold mb-4">Tournaments</h2>
      <ul id="tournamentList" class="space-y-2"></ul>

      <form id="createTournamentForm" class="mt-6">
        <input type="text" id="tournamentName" class="w-full p-2 border rounded mb-2" placeholder="New Tournament" required />
        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Create</button>
      </form>
    </div>

    <div class="flex-1 bg-white p-4 rounded-2xl shadow">
      <h2 class="text-xl font-bold mb-4" id="selectedTournamentTitle">Select a tournament</h2>
      <p id="statusMessage" class="mb-4 text-sm text-gray-600"></p>
      <ul id="playerList" class="space-y-2 mb-4"></ul>

      <div class="flex gap-4">
        <button id="subscribeBtn" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 hidden">Subscribe</button>
        <button id="startBtn" class="bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 hidden">Start Tournament</button>
      </div>
    </div>
  </div>

  <script>
    const tournamentList = document.getElementById("tournamentList");
    const createTournamentForm = document.getElementById("createTournamentForm");
    const tournamentNameInput = document.getElementById("tournamentName");

    const selectedTitle = document.getElementById("selectedTournamentTitle");
    const playerList = document.getElementById("playerList");
    const subscribeBtn = document.getElementById("subscribeBtn");
    const startBtn = document.getElementById("startBtn");
    const statusMessage = document.getElementById("statusMessage");

    let tournaments = [];
    let selectedTournament = null; // tournament id

	const userInfoStr = localStorage.getItem("userInfo");
	if (!userInfoStr) {
		window.location.href = "/login";
	}
	const userInfo = userInfoStr ? JSON.parse(userInfoStr) : null;
	if (!userInfo) {
		window.location.href = "/login";
	}
	const ws = new WebSocket(
		`ws://${window.location.host}/game?token=${userInfo.token}`
	);

	ws.addEventListener("error", (error) => {
  console.error("WebSocket error:", error);
});

ws.addEventListener("close", (e) => {
  if (e.code === 4000) {
    console.log("No token provided");
	window.location.href = "/login";
  } else if (e.code === 4001) {
    console.log("Invalid token");
	window.location.href = "/login";
  } else {
    console.log("Disconnected from the server");
  }
});

    ws.addEventListener("open", () => {
      ws.send(JSON.stringify({ type: "list_tournaments" }));
    });

    ws.addEventListener("message", (event) => {
      const msg = JSON.parse(event.data);
	  console.log(msg);

      if (msg.type === "tournaments") {
        tournaments = msg.data;
        renderTournamentList();
        if (selectedTournament) {
          selectTournament(selectedTournament);
        }
      }
    });

    createTournamentForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = tournamentNameInput.value.trim();
      ws.send(JSON.stringify({
        type: "create_tournament",
        name
      }));

      tournamentNameInput.value = "";
    });

    subscribeBtn.addEventListener("click", () => {
      if (selectedTournament === null) return;

      ws.send(JSON.stringify({
        type: "subscribe",
        tournament: selectedTournament
      }));
    });

    startBtn.addEventListener("click", () => {

      if (selectedTournament === null) return;

      ws.send(JSON.stringify({
        type: "start_tournament",
        tournament: selectedTournament
      }));
    });

    function renderTournamentList() {
      tournamentList.innerHTML = "";
      tournaments.forEach((tournament) => {
        const li = document.createElement("li");
        li.textContent = tournament.name;
        li.className = "cursor-pointer p-2 hover:bg-gray-100 rounded";
        li.addEventListener("click", () => selectTournament(tournament.id));
        tournamentList.appendChild(li);
      });
    }

    function selectTournament(id) {
		console.log("Selected tournament:", id);
		selectedTournament = id;
      const tournament = tournaments.find(t => t.id === selectedTournament);
	  if (!tournament){
		selectedTitle.textContent = "Select a tournament";
		statusMessage.textContent = "No tournament";
		playerList.innerHTML = "";
		subscribeBtn.classList.add("hidden");
		startBtn.classList.add("hidden");
		return;
	  }
	  
      selectedTitle.textContent = `Players in "${tournament.name}"`;
      statusMessage.textContent = tournament.started
        ? "ðŸ This tournament is starting."
        : `Creator: ${tournament.creator.username}`;

      playerList.innerHTML = "";
      tournament.players.forEach(player => {
        const li = document.createElement("li");
        li.textContent = player.username;
        li.className = "border p-2 rounded";
        playerList.appendChild(li);
      });

  
      const isCreator = userInfo.id === tournament.creator.id;
	  playerIds = tournament.players.map(player => player.id);
      if (!tournament.started && !playerIds.includes(userInfo.id)) {
        subscribeBtn.classList.remove("hidden");
      } else {
        subscribeBtn.classList.add("hidden");
      }

      if (!tournament.started && isCreator) {
        startBtn.classList.remove("hidden");
      } else {
        startBtn.classList.add("hidden");
      }
    }
  </script>
</body>
</html>